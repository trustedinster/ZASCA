安全修复 2026-02-02

1. PowerShell注入防护 (utils/winrm_client.py)
   新增_escape_ps_string()转义" $ `三个特殊字符
   用户名白名单校验^[a-zA-Z0-9_]+$
   涉及函数: create_user, create_user_with_reset_password_on_next_login,
            delete_user, enable_user, disabled_user, get_user_info,
            check_user_exists, op_user, deop_user, reset_password, add_to_remote_users

2. CA私钥加密 (apps/certificates/models.py)
   Fernet加密存储，密钥从SECRET_KEY派生
   改动: private_key字段改为_private_key，通过property读写自动加解密
   兼容: try-except回退未加密的旧数据
   涉及模型: CertificateAuthority, ServerCertificate, ClientCertificate

3. 核心测试 (apps/operations/tests.py)
   新建文件，约120行
   TestPowerShellEscape: 转义函数测试
   TestAccountOpeningFlow: 开户流程测试
   TestBurnAfterRead: 阅后即焚测试
   TestSecurityHeaders: 安全头测试

4. CSRF恢复 (apps/accounts/views.py)
   移除@csrf_exempt: password_change_api (行363), upload_avatar (行566)

5. 阅后即焚修复 (apps/operations/models.py)
   函数: CloudComputerUser.get_and_burn_password()
   原逻辑: 首次返回密码，再次调用reset_windows_password生成新密码返回
   新逻辑: 首次返回密码并清空，再次调用抛异常"密码已被查看，无法再次获取"
   行号: 988-1003

6. 权限检查改进
   models.py: CloudComputerUser新增owner字段(ForeignKey到User)
   views.py: my_cloud_computer_detail和get_password_and_burn权限检查改为
            owner优先 -> created_from_request.applicant兜底 -> 都没有返回403
   auto_process_creation创建CloudComputerUser时自动设置owner=self.applicant

7. 事务保护 (apps/operations/models.py)
   函数: AccountOpeningRequest.auto_process_creation()
   改动: WinRM远程操作成功后用transaction.atomic()包裹本地写入
        保证申请状态更新和CloudComputerUser创建原子性
   行号: 602-681

8. 会话安全中间件 (apps/bootstrap/middleware.py)
   SessionValidationMiddleware:
   - 用户指纹: IP + User-Agent哈希(SHA256前32位)
   - 首次访问记录指纹到session._fp
   - 后续访问比对指纹，不匹配则强制登出
   - 劫持尝试记录到SecurityEvent表
   - 会话记录到SessionActivity表
   SessionPersistenceMiddleware:
   - 会话即将过期(<5分钟)时自动延长30分钟

---
迁移命令（必须执行）:
python manage.py makemigrations operations
python manage.py migrate
