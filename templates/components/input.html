{# Material Design 3 输入框组件 #}
<!--{% comment %}-->
使用示例:
{% include 'components/input.html' with
    type="text"               # text, email, password, number, tel, url, search, textarea
    name="username"           # 输入框名称
    id="username"             # 输入框ID
    label="用户名"            # 标签文本
    placeholder="请输入用户名" # 占位符文本（可选）
    value=""                  # 初始值（可选）
    required=false            # 是否必填
    disabled=false            # 是否禁用
    error=""                  # 错误消息（可选）
    helper=""                 # 帮助文本（可选）
    icon="person"             # 前置图标（可选）
    trailing_icon=""          # 后置图标（可选）
    variant="filled"          # filled, outlined
    size="medium"             # small, medium, large
    classes="custom-class"    # 自定义CSS类（可选）
%}
<!--{% endcomment %}-->

{% with type=type|default:"text" variant=variant|default:"filled" size=size|default:"medium" required=required|default:False disabled=disabled|default:False classes=classes|default:"" %}

<div class="md-input-wrapper md-input-wrapper--{{ variant }} md-input-wrapper--{{ size }} {{ classes }}{% if error %} md-input-wrapper--error{% endif %}{% if disabled %} md-input-wrapper--disabled{% endif %}" data-has-value="{% if value %}true{% else %}false{% endif %}" data-initialized="false">
    
    <label class="md-input__label" for="{{ id|default:name }}">{{ label }}{% if required %}<span class="md-input__required">*</span>{% endif %}</label>
    
    {% if icon %}
        <span class="md-input__icon md-input__icon--leading material-icons" data-icon="{{ icon }}">{{ icon }}</span>
    {% endif %}
    
    {% if trailing_icon %}
        <span class="md-input__icon md-input__icon--trailing material-icons" data-icon="{{ trailing_icon }}">{{ trailing_icon }}</span>
    {% endif %}
    
    {% if type == "textarea" %}
        <textarea
            class="md-input md-input--textarea"
            name="{{ name }}"
            id="{{ id|default:name }}"
            {% if placeholder %}placeholder="{{ placeholder }}"{% endif %}
            {% if required %}required{% endif %}
            {% if disabled %}disabled{% endif %}
            {% if rows %}rows="{{ rows }}"{% endif %}
            {% if cols %}cols="{{ cols }}"{% endif %}
        >{{ value|default:"" }}</textarea>
    {% else %}
        <input
            type="{{ type }}"
            class="md-input"
            name="{{ name }}"
            id="{{ id|default:name }}"
            {% if placeholder %}placeholder="{{ placeholder }}"{% endif %}
            {% if value %}value="{{ value }}"{% endif %}
            {% if required %}required{% endif %}
            {% if disabled %}disabled{% endif %}
            {% if min %}min="{{ min }}"{% endif %}
            {% if max %}max="{{ max }}"{% endif %}
            {% if minlength %}minlength="{{ minlength }}"{% endif %}
            {% if maxlength %}maxlength="{{ maxlength }}"{% endif %}
        >
    {% endif %}
    
    {% if helper %}
        <div class="md-input__helper">{{ helper }}</div>
    {% endif %}
    
    {% if error %}
        <div class="md-input__error">{{ error }}</div>
    {% endif %}
</div>

{% endwith %}

<style>
/* MD3 输入框容器 */
.md-input-wrapper {
    position: relative;
    display: block;
    margin-bottom: var(--md-sys-spacing-margin-md);
}

/* 输入框基础样式 */
.md-input {
    width: 100%;
    border: none;
    outline: none;
    background: transparent;
    font-family: inherit;
    font-size: var(--md-sys-typescale-body-large-size);
    color: var(--md-sys-color-on-surface);
    resize: vertical;
    box-sizing: border-box;
    position: relative;
    z-index: 2; /* 确保输入框内容在标签下方 */
}

.md-input::placeholder {
    color: transparent;
}

/* 隐藏浏览器原生密码可见性控件 */
.md-input::-ms-reveal,
.md-input::-ms-clear {
    display: none;
}

/* 隐藏WebKit浏览器的密码眼图标 */
.md-input[type="password"]::-webkit-credentials-auto-fill-button,
.md-input[type="password"]::-webkit-caps-lock-indicator {
    display: none !important;
    visibility: hidden !important;
}

/* 标签样式 */
.md-input__label {
    position: absolute;
    top: 24px;
    left: 16px;
    right: 16px;
    color: var(--md-sys-color-on-surface-variant);
    font-size: var(--md-sys-typescale-body-large-size);
    font-weight: var(--md-sys-typescale-weight-regular);
    pointer-events: none;
    transition: 
        all var(--md-sys-motion-duration-short2) var(--md-sys-motion-easing-standard);
    z-index: 3; /* 确保标签在最上层 */
    background: transparent;
    padding: 0;
    margin: 0;
    line-height: 1.2;
    transform-origin: left top;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    box-sizing: border-box;
}

/* 必填标记 */
.md-input__required {
    color: var(--md-sys-color-error);
    margin-left: 4px;
}

/* 图标样式 */
.md-input__icon {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    color: var(--md-sys-color-on-surface-variant);
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 3; /* 提高图标z-index确保可见 */
    pointer-events: auto;
    width: 24px;
    height: 24px;
    /* Material Icons字体设置 */
    font-family: 'Material Icons', 'MaterialIcons-Regular', sans-serif;
    font-weight: normal;
    font-style: normal;
    line-height: 1;
    text-transform: none;
    letter-spacing: normal;
    word-wrap: normal;
    white-space: nowrap;
    direction: ltr;
    font-feature-settings: 'liga';
    /* 添加背景确保可见 */
    background: transparent;
}

/* SVG图标样式 */
.md-input__icon svg {
    width: 24px;
    height: 24px;
    fill: currentColor;
}

/* 眼睛图标悬停效果 */
.eye-icon:hover, .eye-off-icon:hover {
    opacity: 0.7;
    cursor: pointer;
}

.md-input__icon--leading {
    left: 16px;
}

.md-input__icon--trailing {
    right: 16px;
    cursor: pointer;
}

/* 填充式输入框 */
.md-input-wrapper--filled {
    background-color: var(--md-sys-color-surface-variant);
    border-top-left-radius: var(--md-sys-shape-corner-extra-large);
    border-top-right-radius: var(--md-sys-shape-corner-extra-large);
}

.md-input-wrapper--filled .md-input {
    padding: 20px 12px 8px 44px; /* 优化padding防止溢出 */
    padding-top: 28px; /* 为标签留出空间 */
    box-sizing: border-box;
}

.md-input-wrapper--filled .md-input__label {
    left: 48px;
    right: 16px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    box-sizing: border-box;
}

.md-input-wrapper--filled .md-input__icon--leading {
    left: 12px;
}

.md-input-wrapper--filled .md-input__icon--trailing {
    right: 12px;
}

/* 轮廓式输入框 */
.md-input-wrapper--outlined {
    background-color: transparent;
}

.md-input-wrapper--outlined .md-input {
    padding: 16px;
    border: 1px solid var(--md-sys-color-outline);
    border-radius: var(--md-sys-shape-corner-small);
}

.md-input-wrapper--outlined .md-input__label {
    left: 16px;
    right: 16px;
    background-color: var(--md-sys-color-surface);
    padding: 0 4px;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    box-sizing: border-box;
}

.md-input-wrapper--outlined .md-input__icon--leading {
    left: 16px;
}

.md-input-wrapper--outlined .md-input__icon--trailing {
    right: 16px;
}

/* 尺寸变体 */
.md-input-wrapper--small .md-input {
    font-size: var(--md-sys-typescale-body-small-size);
    padding-top: 16px;
    padding-bottom: 4px;
}

.md-input-wrapper--small .md-input__label {
    font-size: var(--md-sys-typescale-body-small-size);
}

.md-input-wrapper--large .md-input {
    font-size: var(--md-sys-typescale-body-large-size);
    padding-top: 28px;
    padding-bottom: 12px;
}

.md-input-wrapper--large .md-input__label {
    font-size: var(--md-sys-typescale-body-large-size);
}

/* 焦点状态和有值状态 - 完善所有情况 */
.md-input:focus ~ .md-input__label,
.md-input-wrapper[data-has-value="true"] .md-input__label,
.md-input:not(:placeholder-shown) ~ .md-input__label,
.md-input-wrapper--filled .md-input[value]:not([value=""]) ~ .md-input__label,
.md-input-wrapper--filled .md-input:not(:-moz-placeholder-shown) ~ .md-input__label {
    top: 8px;
    font-size: var(--md-sys-typescale-body-small-size);
    color: var(--md-sys-color-primary);
    transform: scale(0.85); /* 缩小效果 */
}

.md-input-wrapper--filled .md-input:focus,
.md-input-wrapper[data-has-value="true"] .md-input-wrapper--filled .md-input,
.md-input-wrapper--filled .md-input:not(:placeholder-shown) {
    background-color: color-mix(in srgb, var(--md-sys-color-on-surface-variant) 4%, var(--md-sys-color-surface-variant));
}

.md-input-wrapper--outlined .md-input:focus {
    border-color: var(--md-sys-color-primary);
    border-width: 2px;
}

.md-input-wrapper--outlined .md-input:focus ~ .md-input__label {
    color: var(--md-sys-color-primary);
}

/* 错误状态 */
.md-input-wrapper--error .md-input {
    border-color: var(--md-sys-color-error);
}

.md-input-wrapper--error .md-input:focus {
    border-color: var(--md-sys-color-error);
}

.md-input-wrapper--error .md-input__label {
    color: var(--md-sys-color-error);
}

.md-input-wrapper--error .md-input__icon {
    color: var(--md-sys-color-error);
}

/* 禁用状态 */
.md-input-wrapper--disabled {
    opacity: 0.38;
}

.md-input-wrapper--disabled .md-input {
    cursor: not-allowed;
}

.md-input-wrapper--disabled .md-input__label {
    color: var(--md-sys-color-on-surface);
}

/* 辅助文本 */
.md-input__helper {
    margin-top: 4px;
    font-size: var(--md-sys-typescale-body-small-size);
    color: var(--md-sys-color-on-surface-variant);
}

/* 错误文本 */
.md-input__error {
    margin-top: 4px;
    font-size: var(--md-sys-typescale-body-small-size);
    color: var(--md-sys-color-error);
}

</style>

<script>
(function() {
    'use strict';
    
    // 初始化所有MD3输入框
    function initMdInputs() {
        const wrappers = document.querySelectorAll('.md-input-wrapper');
        
        wrappers.forEach(wrapper => {
            if (wrapper.dataset.initialized === 'true') return;
            
            const input = wrapper.querySelector('.md-input');
            if (!input) return;
            
            // 检查初始值
            function checkValue() {
                const hasValue = input.value && input.value.trim() !== '';
                wrapper.dataset.hasValue = hasValue;
                
                // 触发重新计算样式
                if (hasValue) {
                    wrapper.classList.add('md-input-wrapper--has-value');
                } else {
                    wrapper.classList.remove('md-input-wrapper--has-value');
                }
            }
            
            // 监听输入事件
            input.addEventListener('input', checkValue);
            input.addEventListener('focus', checkValue);
            input.addEventListener('blur', checkValue);
            
            // 初始化检查
            setTimeout(checkValue, 100);
            
            // 标记为已初始化
            wrapper.dataset.initialized = 'true';
        });
    }
    
    // 页面加载完成后初始化
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initMdInputs);
    } else {
        initMdInputs();
    }
    
    // 支持动态添加的内容
    const observer = new MutationObserver(function(mutations) {
        mutations.forEach(function(mutation) {
            if (mutation.type === 'childList') {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === Node.ELEMENT_NODE) {
                        if (node.classList && node.classList.contains('md-input-wrapper')) {
                            initMdInputs();
                        } else {
                            const inputs = node.querySelectorAll && node.querySelectorAll('.md-input-wrapper');
                            if (inputs.length > 0) {
                                initMdInputs();
                            }
                        }
                    }
                });
            }
        });
    });
    
    observer.observe(document.body, {
        childList: true,
        subtree: true
    });
})();
</script>
</style>