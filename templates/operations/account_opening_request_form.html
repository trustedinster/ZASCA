{% extends 'base.html' %}
{% load static %}

{% block title %}提交开户申请 - ZASCA{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/operations.css' %}">
{% endblock %}

{% block content %}
<div class="container operations-page">
    <div class="page-header">
        <h1>提交开户申请</h1>
    </div>

    {% if messages %}
    <div class="messages">
        {% for message in messages %}
        <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}{{ message.tags }}{% endif %} alert-dismissible fade show">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <div class="card">
        <div class="card-body">
            <h5 class="card-title">申请信息</h5>
            <form id="account-opening-form" method="post">
                {% csrf_token %}

                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label class="form-label">联系邮箱</label>
                            <input type="email" class="form-control" value="{{ request.user.email }}" readonly>
                            <div class="form-text">使用当前账户的注册邮箱，不可修改</div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.contact_phone.id_for_label }}" class="form-label">联系电话</label>
                            {{ form.contact_phone }}
                            {% if form.contact_phone.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.contact_phone.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">可选，提供联系电话便于紧急联系</div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.username.id_for_label }}" class="form-label">主机连接用户名 *</label>
                            {{ form.username }}
                            {% if form.username.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.username.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">将在云电脑主机上创建的连接用户名</div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.user_fullname.id_for_label }}" class="form-label">主机显示用户名 *</label>
                            {{ form.user_fullname }}
                            {% if form.user_fullname.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.user_fullname.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">用于在系统中显示的用户名</div>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="{{ form.requested_password.id_for_label }}" class="form-label">指定密码</label>
                            {{ form.requested_password }}
                            {% if form.requested_password.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.requested_password.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">可选，如不填写则系统将自动生成安全密码</div>
                            
                            <!-- 密码复杂度要求提示 -->
                            <div id="password-requirements" class="password-requirements mt-2" style="display: none;">
                                <small class="text-muted">密码复杂度要求：</small>
                                <ul class="small mb-0" style="margin-top: -5px;">
                                    <li id="req-length"><span class="text-danger">• 至少8个字符</span></li>
                                    <li id="req-uppercase"><span class="text-danger">• 至少一个大写字母</span></li>
                                    <li id="req-lowercase"><span class="text-danger">• 至少一个小写字母</span></li>
                                    <li id="req-number"><span class="text-danger">• 至少一个数字</span></li>
                                    <li id="req-special"><span class="text-danger">• 至少一个特殊字符</span></li>
                                </ul>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="{{ form.user_description.id_for_label }}" class="form-label">申请理由 *</label>
                            {{ form.user_description }}
                            {% if form.user_description.errors %}
                            <div class="invalid-feedback d-block">
                                {% for error in form.user_description.errors %}{{ error }}{% endfor %}
                            </div>
                            {% endif %}
                            <div class="form-text">请说明申请云电脑主机的用途和理由</div>
                        </div>

                        <!-- 隐藏的目标产品字段，通过URL参数传入 -->
                        <div class="target-product-display">
                            <strong>目标产品:</strong> 
                            {% if form.target_product.field.queryset.first %}
                                {{ form.target_product.field.queryset.first.display_name }}
                            {% else %}
                                未指定
                            {% endif %}
                        </div>
                        {{ form.target_product }}
                    </div>
                </div>

                <div class="mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">提交申请并确认</button>
                    <a href="{% url 'operations:account_opening_list' %}" class="btn btn-secondary btn-lg">取消</a>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('{{ form.requested_password.id_for_label }}');
    const passwordRequirements = document.getElementById('password-requirements');
    
    if(passwordInput) {
        // 显示密码复杂度要求
        passwordRequirements.style.display = 'block';
        
        // 实时检查密码强度
        passwordInput.addEventListener('input', function() {
            const password = passwordInput.value;
            checkPasswordStrength(password);
        });
        
        // 页面加载时也检查一次
        if(passwordInput.value) {
            checkPasswordStrength(passwordInput.value);
        }
    }
    
    function checkPasswordStrength(password) {
        // 检查长度（至少8个字符）
        const lengthOk = password.length >= 8;
        document.getElementById('req-length').innerHTML = 
            `<span class="${lengthOk ? 'text-success' : 'text-danger'}">• 至少8个字符</span>`;
        
        // 检查大写字母
        const uppercaseOk = /[A-Z]/.test(password);
        document.getElementById('req-uppercase').innerHTML = 
            `<span class="${uppercaseOk ? 'text-success' : 'text-danger'}">• 至少一个大写字母</span>`;
        
        // 检查小写字母
        const lowercaseOk = /[a-z]/.test(password);
        document.getElementById('req-lowercase').innerHTML = 
            `<span class="${lowercaseOk ? 'text-success' : 'text-danger'}">• 至少一个小写字母</span>`;
        
        // 检查数字
        const numberOk = /\d/.test(password);
        document.getElementById('req-number').innerHTML = 
            `<span class="${numberOk ? 'text-success' : 'text-danger'}">• 至少一个数字</span>`;
        
        // 检查特殊字符
        const specialCharOk = /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password);
        document.getElementById('req-special').innerHTML = 
            `<span class="${specialCharOk ? 'text-success' : 'text-danger'}">• 至少一个特殊字符</span>`;
    }
    
    // 表单提交前验证密码
    const form = document.getElementById('account-opening-form');
    if(form) {
        form.addEventListener('submit', function(e) {
            const password = passwordInput ? passwordInput.value : '';
            
            // 如果用户输入了密码，检查其复杂度
            if(password && password.length > 0) {
                const lengthOk = password.length >= 8;
                const uppercaseOk = /[A-Z]/.test(password);
                const lowercaseOk = /[a-z]/.test(password);
                const numberOk = /\d/.test(password);
                const specialCharOk = /[!@#$%^&*()_+\-=\[\]{}|;:,.<>?]/.test(password);
                
                if(!(lengthOk && uppercaseOk && lowercaseOk && numberOk && specialCharOk)) {
                    e.preventDefault();
                    
                    let errorMsg = '密码不符合复杂度要求：\n';
                    if(!lengthOk) errorMsg += '- 至少8个字符\n';
                    if(!uppercaseOk) errorMsg += '- 至少一个大写字母\n';
                    if(!lowercaseOk) errorMsg += '- 至少一个小写字母\n';
                    if(!numberOk) errorMsg += '- 至少一个数字\n';
                    if(!specialCharOk) errorMsg += '- 至少一个特殊字符\n';
                    
                    alert(errorMsg);
                    return false;
                }
            }
        });
    }
});
</script>
{% endblock %}