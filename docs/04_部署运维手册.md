# ZASCA 部署运维手册

## 1. 系统要求

### 1.1 服务器硬件要求

#### 最小配置（开发/测试环境）
- CPU: 2 核心
- 内存: 4 GB RAM
- 磁盘: 20 GB SSD
- 网络: 100 Mbps

#### 推荐配置（生产环境）
- CPU: 4+ 核心
- 内存: 8+ GB RAM
- 磁盘: 50+ GB SSD
- 网络: 1 Gbps

### 1.2 软件环境要求

#### 操作系统
- Ubuntu 20.04 LTS 或更高版本
- CentOS 7.9 或更高版本
- Rocky Linux 8.x 或更高版本

#### 运行时环境
- Python 3.8+ （推荐 3.11+）
- PostgreSQL 12+ （推荐 14+）
- Redis 6.0+ （推荐 7.0+）
- Node.js 16+ （前端构建需要）

## 2. 环境准备

### 2.1 系统初始化

```bash
# 更新系统包
sudo apt update && sudo apt upgrade -y

# 安装基础依赖
sudo apt install -y \
    python3-pip \
    python3-dev \
    python3-venv \
    build-essential \
    libpq-dev \
    postgresql \
    postgresql-contrib \
    redis-server \
    nginx \
    supervisor \
    git

# 创建专用用户
sudo useradd -m -s /bin/bash zasca
sudo usermod -aG sudo zasca
```

### 2.2 数据库配置

```bash
# 启动 PostgreSQL
sudo systemctl enable postgresql
sudo systemctl start postgresql

# 创建数据库和用户
sudo -u postgres psql << EOF
CREATE DATABASE zasca_prod;
CREATE USER zasca_user WITH PASSWORD 'strong_password_here';
GRANT ALL PRIVILEGES ON DATABASE zasca_prod TO zasca_user;
ALTER USER zasca_user CREATEDB;
EOF

# 配置 PostgreSQL 认证
sudo sed -i "s/#listen_addresses = 'localhost'/listen_addresses = '*'/g" /etc/postgresql/*/main/postgresql.conf
echo "host    all             all             0.0.0.0/0               md5" | sudo tee -a /etc/postgresql/*/main/pg_hba.conf
sudo systemctl restart postgresql
```

### 2.3 Redis 配置

```bash
# 启动 Redis
sudo systemctl enable redis-server
sudo systemctl start redis-server

# Redis 安全配置
sudo sed -i 's/# requirepass foobared/requirepass your_redis_password/g' /etc/redis/redis.conf
sudo systemctl restart redis-server
```

## 3. 应用部署

### 3.1 代码获取与环境设置

```bash
# 切换到 zasca 用户
sudo su - zasca

# 克隆代码
git clone https://github.com/your-org/zasca.git /home/zasca/app
cd /home/zasca/app

# 创建虚拟环境
python3 -m venv venv
source venv/bin/activate

# 安装依赖
pip install --upgrade pip
pip install -r requirements.txt

# 如果有前端依赖
npm install
npm run build
```

### 3.2 环境变量配置

创建 `.env` 文件：

```bash
# 基础配置
DEBUG=False
SECRET_KEY=your-super-secret-key-here-change-this-in-production
ALLOWED_HOSTS=your-domain.com,www.your-domain.com

# 数据库配置
DB_HOST=localhost
DB_PORT=5432
DB_NAME=zasca_prod
DB_USER=zasca_user
DB_PASSWORD=strong_password_here

# Redis 配置
REDIS_URL=redis://:your_redis_password@localhost:6379/0

# 邮件配置
EMAIL_BACKEND=django.core.mail.backends.smtp.EmailBackend
EMAIL_HOST=smtp.your-email-provider.com
EMAIL_PORT=587
EMAIL_USE_TLS=True
EMAIL_HOST_USER=your-email@domain.com
EMAIL_HOST_PASSWORD=your-email-password

# 安全配置
SECURE_SSL_REDIRECT=True
SECURE_PROXY_SSL_HEADER=('HTTP_X_FORWARDED_PROTO', 'https')
SESSION_COOKIE_SECURE=True
CSRF_COOKIE_SECURE=True
SECURE_HSTS_SECONDS=31536000
SECURE_HSTS_INCLUDE_SUBDOMAINS=True
SECURE_HSTS_PRELOAD=True

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=/var/log/zasca/application.log

# Celery 配置
CELERY_BROKER_URL=redis://:your_redis_password@localhost:6379/1
CELERY_RESULT_BACKEND=redis://:your_redis_password@localhost:6379/2
```

### 3.3 数据库迁移与初始化

```bash
# 激活虚拟环境
source venv/bin/activate

# 数据库迁移
python manage.py makemigrations
python manage.py migrate

# 创建超级用户
python manage.py createsuperuser

# 初始化演示数据（可选）
python manage.py init_demo

# 收集静态文件
python manage.py collectstatic --noinput
```

### 3.4 Gunicorn 配置

创建 Gunicorn 配置文件 `/home/zasca/gunicorn.conf.py`：

```python
import multiprocessing

bind = "127.0.0.1:8000"
workers = multiprocessing.cpu_count() * 2 + 1
worker_class = "sync"
worker_connections = 1000
timeout = 30
keepalive = 2
max_requests = 1000
max_requests_jitter = 100
preload_app = True

# 日志配置
accesslog = "/var/log/zasca/gunicorn_access.log"
errorlog = "/var/log/zasca/gunicorn_error.log"
loglevel = "info"
capture_output = True

# 进程名
proc_name = "zasca"
```

## 4. 服务配置

### 4.1 Supervisor 配置

创建 Supervisor 配置文件 `/etc/supervisor/conf.d/zasca.conf`：

```ini
[group:zasca]
programs=gunicorn,celery-beat,celery-worker

[program:gunicorn]
command=/home/zasca/app/venv/bin/gunicorn config.wsgi:application -c /home/zasca/gunicorn.conf.py
directory=/home/zasca/app
user=zasca
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/zasca/gunicorn_supervisor.log
environment=HOME="/home/zasca",USER="zasca"

[program:celery-worker]
command=/home/zasca/app/venv/bin/celery -A config worker -l INFO
directory=/home/zasca/app
user=zasca
numprocs=2
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/zasca/celery_worker.log

[program:celery-beat]
command=/home/zasca/app/venv/bin/celery -A config beat -l INFO
directory=/home/zasca/app
user=zasca
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/zasca/celery_beat.log
```

启动 Supervisor：
```bash
sudo supervisorctl reread
sudo supervisorctl update
sudo supervisorctl start zasca:*
```

### 4.2 Nginx 配置

创建 Nginx 配置文件 `/etc/nginx/sites-available/zasca`：

```nginx
upstream zasca_app {
    server 127.0.0.1:8000;
}

server {
    listen 80;
    server_name your-domain.com www.your-domain.com;
    
    # 重定向到 HTTPS
    return 301 https://$server_name$request_uri;
}

server {
    listen 443 ssl http2;
    server_name your-domain.com www.your-domain.com;
    
    # SSL 证书配置
    ssl_certificate /path/to/your/certificate.crt;
    ssl_certificate_key /path/to/your/private.key;
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384;
    ssl_prefer_server_ciphers off;
    
    # 安全头
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
    
    # 客户端最大上传大小
    client_max_body_size 100M;
    
    # 静态文件
    location /static/ {
        alias /home/zasca/app/staticfiles/;
        expires 1y;
        add_header Cache-Control "public, immutable";
    }
    
    location /media/ {
        alias /home/zasca/app/media/;
        expires 1d;
    }
    
    # 应用代理
    location / {
        proxy_pass http://zasca_app;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 超时设置
        proxy_connect_timeout 30s;
        proxy_send_timeout 30s;
        proxy_read_timeout 30s;
    }
    
    # 健康检查
    location /health/ {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
```

启用站点：
```bash
sudo ln -s /etc/nginx/sites-available/zasca /etc/nginx/sites-enabled/
sudo nginx -t
sudo systemctl reload nginx
```

## 5. 日志管理

### 5.1 日志目录结构

```bash
sudo mkdir -p /var/log/zasca
sudo chown zasca:zasca /var/log/zasca
```

### 5.2 Logrotate 配置

创建 `/etc/logrotate.d/zasca`：

```bash
/var/log/zasca/*.log {
    daily
    missingok
    rotate 30
    compress
    delaycompress
    notifempty
    create 644 zasca zasca
    postrotate
        supervisorctl restart zasca:* > /dev/null 2>&1 || true
    endscript
}
```

## 6. 监控配置

### 6.1 系统监控脚本

创建监控脚本 `/home/zasca/monitor.sh`：

```bash
#!/bin/bash

# 检查服务状态
check_services() {
    services=("nginx" "postgresql" "redis-server" "supervisor")
    
    for service in "${services[@]}"; do
        if ! systemctl is-active --quiet "$service"; then
            echo "Service $service is not running"
            systemctl start "$service"
        fi
    done
}

# 检查应用进程
check_processes() {
    if ! pgrep -f "gunicorn.*config.wsgi" > /dev/null; then
        echo "Gunicorn process not found"
        supervisorctl restart zasca:gunicorn
    fi
}

# 检查磁盘空间
check_disk_space() {
    threshold=90
    usage=$(df / | tail -1 | awk '{print $5}' | sed 's/%//')
    
    if [ "$usage" -gt "$threshold" ]; then
        echo "Disk usage is ${usage}% - cleaning logs"
        find /var/log/zasca -name "*.log.*" -mtime +7 -delete
    fi
}

# 执行检查
check_services
check_processes
check_disk_space
```

设置定时任务：
```bash
# 添加到 crontab
*/5 * * * * /home/zasca/monitor.sh >> /var/log/zasca/monitor.log 2>&1
```

### 6.2 健康检查端点

在 `config/urls.py` 中添加健康检查：

```python
from django.http import HttpResponse

def health_check(request):
    return HttpResponse("OK", content_type="text/plain")

urlpatterns = [
    path('health/', health_check, name='health_check'),
    # ... 其他路由
]
```

## 7. 备份策略

### 7.1 数据库备份脚本

创建 `/home/zasca/backup_db.sh`：

```bash
#!/bin/bash

BACKUP_DIR="/home/zasca/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/zasca_${DATE}.sql"

# 创建备份目录
mkdir -p "$BACKUP_DIR"

# 数据库备份
pg_dump -h localhost -U zasca_user zasca_prod > "$BACKUP_FILE"

# 压缩备份文件
gzip "$BACKUP_FILE"

# 清理旧备份（保留7天）
find "$BACKUP_DIR" -name "zasca_*.sql.gz" -mtime +7 -delete

# 记录备份日志
echo "$(date): Database backup completed - ${BACKUP_FILE}.gz" >> /var/log/zasca/backup.log
```

### 7.2 应用文件备份

创建 `/home/zasca/backup_app.sh`：

```bash
#!/bin/bash

BACKUP_DIR="/home/zasca/backups"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/app_${DATE}.tar.gz"

# 创建备份
tar -czf "$BACKUP_FILE" \
    -C /home/zasca/app \
    --exclude='.git' \
    --exclude='*.pyc' \
    --exclude='__pycache__' \
    --exclude='media/cache' \
    .

# 清理旧备份（保留3天）
find "$BACKUP_DIR" -name "app_*.tar.gz" -mtime +3 -delete

echo "$(date): Application backup completed - ${BACKUP_FILE}" >> /var/log/zasca/backup.log
```

### 7.3 自动备份配置

添加到 crontab：
```bash
# 每天凌晨2点备份数据库
0 2 * * * /home/zasca/backup_db.sh

# 每周日凌晨3点备份应用
0 3 * * 0 /home/zasca/backup_app.sh
```

## 8. 安全加固

### 8.1 防火墙配置

```bash
# UFW 配置
sudo ufw default deny incoming
sudo ufw default allow outgoing
sudo ufw allow ssh
sudo ufw allow 'Nginx Full'
sudo ufw enable
```

### 8.2 SSH 安全配置

编辑 `/etc/ssh/sshd_config`：
```bash
Port 2222  # 更改默认端口
PermitRootLogin no
PasswordAuthentication no
AllowUsers zasca
MaxAuthTries 3
ClientAliveInterval 300
ClientAliveCountMax 2
```

重启 SSH：
```bash
sudo systemctl restart sshd
```

### 8.3 应用安全配置

在 `settings.py` 中加强安全配置：

```python
# 安全中间件
MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'config.maintenance_middleware.MaintenanceModeMiddleware',  # 维护模式
    'corsheaders.middleware.CorsMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

# CORS 配置
CORS_ALLOWED_ORIGINS = [
    "https://your-domain.com",
]

# 内容安全策略
SECURE_CONTENT_TYPE_NOSNIFF = True
SECURE_BROWSER_XSS_FILTER = True
X_FRAME_OPTIONS = 'DENY'

# 会话安全
SESSION_COOKIE_AGE = 3600  # 1小时
SESSION_EXPIRE_AT_BROWSER_CLOSE = True
SESSION_COOKIE_HTTPONLY = True
```

## 9. 故障排除

### 9.1 常见问题诊断

#### 服务无法启动
```bash
# 检查端口占用
sudo netstat -tlnp | grep :8000

# 查看应用日志
tail -f /var/log/zasca/gunicorn_error.log

# 检查权限
ls -la /home/zasca/app
```

#### 数据库连接问题
```bash
# 测试数据库连接
psql -h localhost -U zasca_user -d zasca_prod

# 检查 PostgreSQL 状态
sudo systemctl status postgresql
```

#### 静态文件 404
```bash
# 重新收集静态文件
python manage.py collectstatic --noinput

# 检查 Nginx 配置
sudo nginx -t
```

### 9.2 性能调优

#### 数据库优化
```sql
-- 创建必要索引
CREATE INDEX CONCURRENTLY idx_hosts_hostname_gin ON hosts_host USING gin(hostname gin_trgm_ops);
CREATE INDEX CONCURRENTLY idx_audit_timestamp_brin ON audit_auditlog USING brin(timestamp);

-- 分析表统计信息
ANALYZE hosts_host;
ANALYZE operations_accountopeningrequest;
```

#### 应用性能优化
```python
# 在 settings.py 中调整
DATABASES = {
    'default': {
        # 连接池配置
        'CONN_MAX_AGE': 60,
        'OPTIONS': {
            'MAX_CONNS': 20,
        }
    }
}

# 缓存配置
CACHES = {
    'default': {
        'BACKEND': 'django_redis.cache.RedisCache',
        'LOCATION': 'redis://127.0.0.1:6379/0',
        'OPTIONS': {
            'CLIENT_CLASS': 'django_redis.client.DefaultClient',
        }
    }
}
```

## 10. 升级维护

### 10.1 应用升级流程

```bash
# 1. 备份当前版本
sudo supervisorctl stop zasca:*
/home/zasca/backup_app.sh

# 2. 拉取最新代码
cd /home/zasca/app
git pull origin main

# 3. 更新依赖
source venv/bin/activate
pip install -r requirements.txt

# 4. 数据库迁移
python manage.py migrate

# 5. 收集静态文件
python manage.py collectstatic --noinput

# 6. 重启服务
sudo supervisorctl start zasca:*

# 7. 验证服务状态
curl -f http://localhost:8000/health/
```

### 10.2 回滚方案

```bash
# 回滚到指定版本
cd /home/zasca/app
git reset --hard <commit-hash>
git clean -fd

# 重启服务
sudo supervisorctl restart zasca:*
```

---
*文档版本：V1.0*  
*最后更新：2026年2月3日*